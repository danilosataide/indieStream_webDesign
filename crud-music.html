
<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="js/jquery-3.5.1.min.js"></script>
    <script>
        $( "head" ).load( "head-html.html" );

        $( "head" ).load( "head-html.html", function( response, status, xhr ) {
            if ( status == "error" ) {
            var msg = "Desculpe, mas ocorreu um erro: " + xhr.status + " " + xhr.statusText;
            // $( "#error" ).html( msg + xhr.status + " " + xhr.statusText );
            alert (msg);
            }
        });
    </script>
</head>

<body onload="init()">
    <div class="page-wrapper default-theme sidebar-bg bg1 toggled">
        <div id="sidebar-html"></div>
        
        <script>
            $( "#sidebar-html" ).load( "sidebar-html.html" );
        </script>
        
        <!-- page-content  -->
        <main class="page-content pt-2">

            <div id="navbar-html"></div>
        
            <script>
                $( "#navbar-html" ).load( "navbar-html.html" );
            </script>

            <div id="overlay" class="overlay"></div>
            <div class="container-fluid p-5">
                <!-- COLOCAR CONTEUDO AQUI PARA BAIXO -->

                <h1>Músicas</h1>

                <!-- <div class="container"> -->
                    <div class="row mt-3">
                        <div class="col-sm-2">
                            <!-- Button trigger modal -->
                            <button type="button" class="btn btn-primary" id="btnNovo">
                                
                                <span>
                                    <img src="./assets/plus.svg" alt="...">
                                    <img src="./assets/music-24.svg" alt="...">
                                </span>
                                
                                
                            </button>
                        </div>
                    </div>

                    <!-- Espacer -->
                    <div class="mt-3"></div>

                    <!-- ModalForm -->
                    <div class="modal fade" id="ModalForm" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="exampleModalLabel"><span id="ModalFormTitle"></span></h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <!-- <h4 id="IdForm"></h4> -->
                                    <form id="form-musicas">
                                        <div id="msg">
                                        </div>
                                        <div class="form-group row">
                                            <input type="text" class="form-control" id="inputIdForm" placeholder="ID" disabled hidden>
                                            <div class="col-sm-6">
                                                <label for="inputNomeForm">Nome <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="inputNomeForm" placeholder="Informe o nome"
                                                    required>
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="inputArtistaForm">Artista <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="inputArtistaForm" required placeholder="Informe o artista">
                                            </div>
                                        </div>
                                        <div class="form-group row">

                                            <div class="col-sm-6">
                                                <label for="selectGeneroForm">Gênero<span class="text-danger">*</span></label>
                                                <select id="selectGeneroForm" class="form-control" required>
                                                    <option disabled selected>Selecione o gênero</option>
                                                    <option value="Alternativo e punk">Alternativo e punk</option>
                                                    <option value="Ambiente">Ambiente</option>
                                                    <option value="Infantil">Infantil</option>
                                                    <option value="Trilha sonora de cinema">Trilha sonora de cinema</option>
                                                    <option value="Clássica">Clássica</option>
                                                    <option value="Country e folk">Country e folk</option>
                                                    <option value="Dance e eletrônica">Dance e eletrônica</option>
                                                    <option value="Hip-Hop e rap">Hip-Hop e rap</option>
                                                    <option value="Natalina">Natalina</option>
                                                    <option value="Jazz e blues">Jazz e blues</option>
                                                    <option value="Pop">Pop</option>
                                                    <option value="R&B e soul">R&B e soul</option>
                                                    <option value="Reggae">Reggae</option>
                                                    <option value="Rock">Rock</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="selectClimaForm">Clima<span class="text-danger">*</span></label>
                                                <select id="selectClimaForm" class="form-control" required>
                                                    <option disabled selected>Selecione o clima</option>
                                                    <option value="Raiva">Raiva</option>
                                                    <option value="Animado">Animado</option>
                                                    <option value="Calmo">Calmo</option>
                                                    <option value="Sombrio">Sombrio</option>
                                                    <option value="Dramático">Dramático</option>
                                                    <option value="Vibrante">Vibrante</option>
                                                    <option value="Alegre">Alegre</option>
                                                    <option value="Inspirador">Inspirador</option>
                                                    <option value="Romântico">Romântico</option>
                                                    <option value="Melancólico">Melancólico</option>
                                                </select>
                                            </div>
                                        </div>
                                        <hr>    
                                        <div class="form-group row">
                                            <div class="col-sm-6">
                                                <label>Arte de Capa</label><br>
                                                <img id='ImgUploadForm' src="./assets/placeholder-music.png" class="rounded-lg" width="125" height="125"/>
                                            
                                                <div class="btn-group" role="group" aria-label="Basic example">
                                                    <span class="input-group-btn">
                                                        <span class="btn btn-sm btn-light btn-file">
                                                            <input type="file" id="InputImgForm">
                                                            <img src="./assets/upload.svg" alt="...">
                                                        </span>
                                                    </span>
                                                    <span class="btn btn-sm btn-light removerImg">
                                                        <a id="removerImg" class="">Remover imagem de capa</a>
                                                    </span>
                                                </div>
                                               
                                            </div>
                                            
                                            <div class="col-sm-6">
                                                <label>Arquivo de áudio</label>
                                                <!-- <a id="removerAudio" class="btn btn-sm btn-light">Remover imagem de capa</a>
                                                <div class="input-group">
                                                    <span class="input-group-btn">
                                                        <span class="btn btn-sm btn-light btn-file">
                                                            <input type="file" id="InputAudioForm">
                                                            <img src="./assets/music-20.svg" alt="...">
                                                        </span>
                                                    </span>
                                                </div>
                                                <br> -->
                                                <audio controls="controls" id="audioPlayer">
                                                    Your browser does not support the audio element.
                                                </audio>

                                                <div class="btn-group" role="group" aria-label="Basic example">
                                                    <span class="input-group-btn">
                                                        <span class="btn btn-sm btn-light btn-file">
                                                            <input type="file" id="InputAudioForm">
                                                            <img src="./assets/music-20.svg" alt="...">
                                                        </span>
                                                    </span>
                                                    <a id="removerAudio" class="btn btn-sm btn-light">Remover arquivo de áudio</a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-sm-4">
                                                <small><span class="text-danger">*</span> Campos obrigatórios</small>
                                            </div>
                                        </div>

                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <input type="button" class="btn btn-success btn-sm modoInsert" id="btnInsert" value="Inserir">
                                    <input type="button" class="btn btn-success btn-sm modoAlterar" id="btnUpdate" value="Alterar">
                                    <input type="button" class="btn btn-primary btn-sm modoInsert" id="btnGoDelete2" value="Excluir">
                                    <input type="button" class="btn btn-light btn-sm modoAlterar" id="btnClear" value="Limpar Form">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ModalView -->
                    <div class="modal fade" id="ModalView" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="exampleModalLabel"><span id="ModalViewTitle"></span></h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-flex justify-content-start flex-row bd-highlight mb-3">
                                        <div class="p-2 bd-highlight">
                                            <img id='imgUploadView' src="" alt="..." class="rounded-lg" width="125" height="125">
                                        </div>
                                        <div class="p-2 bd-highlight"> 
                                            <h3 id="inputNomeView"></h3>
                                            <h4 id="inputArtistaView"></h4>
                                            <br>
                                            <p id="pInfo"></p>
                                           
                                        </div>
                                        <div class="p-2 bd-highlight"> 
                                            <audio controls="controls" id="audioPlayerDemo" hidden>
                                                Your browser does not support the audio element.
                                            </audio>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" id="inputIdView" hidden>
                                    <!-- <form id="form-musicas">

                                        <div class="form-group row">
                                            <div class="col-sm-2">
                                                <label for="inputIdView">ID</label>
                                                <input type="text" class="form-control" id="inputIdView" disabled>
                                            </div>
                                            <div class="col-sm-3">
                                                <label for="inputNomeView">Nome</label>
                                                <input type="text" class="form-control" id="inputNomeView" disabled>
                                            </div>
                                            <div class="col-sm-7">
                                                <label for="inputArtistaView">Artista</label>
                                                <input type="text" class="form-control" id="inputArtistaView" disabled>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-sm-4">
                                                <label for="inputGeneroView">Gênero</label>
                                                <input type="text" class="form-control" id="inputGeneroView" disabled>
                                            </div>
                                            <div class="col-sm-4">
                                                <label for="inputClimaView">Clima</label>
                                                <input type="text" class="form-control" id="inputClimaView" disabled>
                                            </div>
                                            <div class="form-group col-sm-4">
                                                <label>Imagem</label>
                                                <img id='imgUploadView' src="" />
                                            </div>
                                        </div>
                                    </form> -->
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-dark rounded-lg btn-sm" id="btnGoUpdate" value="Alterar"><img src="./assets/edit.svg"> Alterar</button>
                                    <button type="button" class="btn btn-danger rounded-lg btn-sm" id="btnGoDelete" value="Excluir"><img src="./assets/trash-2.svg"> Excluir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fim alterações -->

                    <div class="row">
                        <div class="col-sm-12">
                            <table id="grid-musicas" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Nome</th>
                                        <th scope="col">Artista</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="table-musicas">
                                    <tr>
                                        <td scope="row">1</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <!-- </div> -->
                <!-- class="container" -->
            
        </main>
        <!-- page-content" -->
    </div>
    <!-- page-wrapper -->

    <script src="js/fakedb.js"></script> 
    
    <script>
        var isAlterar = false;
        var isExcluir = false;

        function exibeMusicas() {
            // Remove todas as linhas do corpo da tabela
            $("#table-musicas").html("");
            // Popula a tabela com os registros do banco de dados
        
            let buttonAlterar = `<button id="btnGoUpdate" type="button" class="btn btn-dark btn-sm mr-1 rounded-lg"><img src="./assets/edit.svg"></button>`
            let buttonExcluir = `<button id="btnDelete" type="button" class="btn btn-danger btn-sm rounded-lg"><img src="./assets/trash-2.svg"></button>`

            for (i = 0; i < db.data.length; i++) {
                let musicas = db.data[i];
                $("#table-musicas").append(`<tr><td>${musicas.id}</td><td>${musicas.nome}</td><td>${musicas.artista}</td><td>${buttonAlterar}${buttonExcluir}</td></tr>`);
            }
        }

        function init() {
            // $(elemento).click(funcao () {
                
            // })

            // $(elemento).on(evento, funcao () {

            // })

            // $(container).on(evento, filhos, funcao () {

            // })

            // Preenche o formulário (modal) quando o usuario clicar em uma linha da tabela 
            $("#grid-musicas").on("click", "tr", "td", function (e) {
                let id = this.childNodes[0].firstChild.nodeValue;
                // let index = db.data.map(obj => obj.id).indexOf(parseInt(id));
                let musicas = db.data[db.data.map(obj => obj.id).indexOf(parseInt(id))];
                if (id == "") {
                    return;  
                }
                if (!isAlterar && !isExcluir) {
                    // alert('View');
                    // isAlterar = false;
                    $('#ModalView').modal('show');
                    $('#ModalViewTitle').text('#' + id);
                    $('#inputIdView').val(id);
                    if(musicas.audio == null || musicas.audio == ''){
                        $('#inputNomeView').html(`${musicas.nome} <img src="./assets/volume-x.svg" alt="">`);
                    } else {
                        $('#inputNomeView').html(`${musicas.nome} <img src="./assets/volume-2.svg" alt="">`);
                        $("#audioPlayerDemo").attr('src', musicas.audio);
                        $("#audioPlayerDemo")[0].play();
                    }
                    $('#inputArtistaView').text(musicas.artista);
                    // $('#pGenero').html(`<strong>Gênero: </strong>${musicas.genero}`);
                    // $('#pClima').html(`<strong>Clima: </strong>${musicas.clima}`);
                    $('#pInfo').html(`<strong>Gênero: </strong>${musicas.genero} - <strong>Clima: </strong>${musicas.clima}`);
                    $('#imgUploadView').attr('src', musicas.imagem);
                    
                } else if (isExcluir) {
                    isExcluir = false;
                    deleteMusic(parseInt(id));
                    //Reexibe as musicas
                    exibeMusicas();
                } else {
                    if(isAlterar){
                        isAlterar = false;
                        modalUpdate(id);
                    }
                }
            });

            // Intercepta o click do botão Alterar
            $("#table-musicas").on('click', '#btnGoUpdate', function () {
                isAlterar = true;
            });

            // Intercepta o click do botão Excluir
            $("#table-musicas").on('click', '#btnDelete', function () {
                isExcluir = true;
                // let id =  $(this).parent().parent()[0].childNodes[0].firstChild.nodeValue  
                
                // if (id == "") {
                //     return;  
                // }
            });

            // Escuta o evento do fechamendo do modal ModalForm
            $('#ModalView').on('hidden.bs.modal', function () {
                $("#audioPlayerDemo")[0].pause();
            });

            // Intercepta o click do botão Limpar (ModalForm)
            $("#btnClear").click(function () {
                $("#form-musicas")[0].reset();
            });

            // Intercepta o click do botão Novo Registro
            $("#btnNovo").click(function () {
                ///alert('btnNovo')
                $("#form-musicas")[0].reset();
                $('#ModalForm').modal('show');
                $('#ImgUploadForm').attr('src', "./assets/placeholder-music.png");
                $('.modoAlterar').css("display", "none");
                $('#btnGoDelete2').css("display", "none");
                $('#btnClear').css("display", "block");
                $('#btnInsert').css("display", "block");
                $('#msg').css("display", "none");
                let proxId = proxIdMusic();
                $('#ModalFormTitle').text(`#${proxId} - Nova música`);
            });

            // Escuta o evento do fechamendo do modal ModalForm
            $('#ModalForm').on('hidden.bs.modal', function () {
                $('#btnInsert').css("display", "none");
                $('.modoAlterar').css("display", "none");
                $('#ImgUploadForm').attr('src', "./assets/placeholder-music.png");
                imgb64 = "./assets/placeholder-music.png";
                $('#ModalFormTitle').text("");
                $("#audioPlayer")[0].pause();
                audiob64 = "";
            });

            // Intercepta o click do botão Remover Imagem de Capa (ModalForm)
            $("#removerImg").click(function () {
                $('#ImgUploadForm').attr('src', "./assets/placeholder-music.png");
                imgb64 = "./assets/placeholder-music.png";
            });

            // Intercepta o click do botão Remover Arquivo de Audio (ModalForm)
            $("#removerAudio").click(function () {
                $('#audioPlayer').attr('src', "");
                audiob64 = "";
            });

            // Adiciona funções para tratar os eventos 
            $("#btnInsert").click(function () {
                // Verfica se o formulário está preenchido corretamente
                if (!$('#form-musicas')[0].checkValidity()) {
                    displayMessage("Preencha o formulário corretamente.");
                    return;
                }

                if($("#selectGeneroForm").val() == null || $("#selectClimaForm").val() == null){
                    displayMessage("Preencha os campos obrigatórios.");
                    return;
                }
               
                // Obtem os valores dos campos do formulários   
                let nomef = $('#inputNomeForm').val();
                let artistaf = $('#inputArtistaForm').val();
                let generof = $("#selectGeneroForm").val();
                let climaf = $('#selectClimaForm').val();
                let imgu = imgb64;
                if(imgb64 == null)
                    imgb64 = './assets/placeholder-music.png';
                alert(imgb64)
                alert(audiob64)


                let musica = { nome: nomef, artista: artistaf, genero: generof, clima: climaf, imagem: imgb64, audio: audiob64};

                insertMusic(musica);
                
                // Reexibe as músicas
                exibeMusicas();
                // Limpa o formulario
                $("#form-musicas")[0].reset();
                $('#ModalForm').modal('toggle');
            });

            // Intercepta o click do botão Alterar (ModalForm)
            $("#btnUpdate").click(function () {
                // $("#table-musicas").on('click', '#btnUpdate', function () {
                // Obtem os valores dos campos do formulário
                // let campoId = $(this).parent().parent()[0].childNodes[0].firstChild.nodeValue; 
                let Idu = $("#inputIdForm").val();
                // if (campoId == "") {
                //     displayMessage("Selecione uma musica para ser alterada.");
                //     return;
                // }
                let nomeu = $('#inputNomeForm').val();
                let artistau = $('#inputArtistaForm').val();
                let generou = $("#selectGeneroForm").val();
                let climau = $('#selectClimaForm').val();
                let imgu = imgb64;
                let audiou = audiob64;
                alert(audiob64)

                // console.log(iImg);                   
                let musica = { nome: nomeu, artista: artistau, genero: generou, clima: climau, imagem: imgb64, audio: audiou};
                updateMusic(parseInt(Idu), musica);
                // Reexibe as músicas
                exibeMusicas();
                // Limpa o formulario
                $("#form-musicas")[0].reset();
                $('#ModalForm').modal('toggle');
            });

            // Intercepta o click do botão Excluir (ModalView)
            $("#btnGoDelete").click(function () {
                let id = $("#inputIdView").val();
                if (id == "") {
                    return;
                }
                deleteMusic(parseInt(id));

                // Reexibe as musicas
                exibeMusicas();
                // Fecha o modal
                $('#ModalView').modal('toggle');
            });

            // Intercepta o click do botão Alterar (ir para update) (ModalView)
            $("#btnGoUpdate").click(function () {
                let id = $("#inputIdView").val();
                $('#ModalView').modal("hide");//toggle
                //jQuery("#exampleModal2").modal("hide");
                modalUpdate(id);
            });

            exibeMusicas();
        }

        function modalUpdate(id) {
            let musicas = db.data[db.data.map(obj => obj.id).indexOf(parseInt(id))];
            $('#ModalForm').modal('show');
            $('.modoInsert').css("display", "none");
            $('.modoAlterar').css("display", "block");
            $('#ModalFormTitle').text(`#${id} - Alterar música`);
            $('#inputIdForm').val(id);
            // $('#IdForm').text('#' + id);
            $('#inputNomeForm').val(musicas.nome);
            $('#inputArtistaForm').val(musicas.artista);
            $('#selectGeneroForm').val(musicas.genero);
            $('#selectClimaForm').val(musicas.clima);
            $('#ImgUploadForm').attr('src', musicas.imagem);
            imgb64 = musicas.imagem;

            $('#audioPlayer').attr('src', musicas.audio);
            audiob64 = musicas.audio;
        }

    </script>

    <!-- using online scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous">
    </script>
    <script src="//malihu.github.io/custom-scrollbar/jquery.mCustomScrollbar.concat.min.js"></script>

    <script src="js/main.js"></script>

    <script>
        var imgb64 = null;
        var audiob64 = null;
        var changed = false;
        var changedAudio = false;

        $(document).ready(function () {
            $(document).on('change', '.btn-file :file', function () {
                var input = $(this),
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                input.trigger('fileselect', [label]);
            });

            $('.btn-file :file').on('fileselect', function (event, label) {

                var input = $(this).parents('.input-group').find(':text'),
                    log = label;

                if (input.length) {
                    input.val(log);
                } else {
                    if (log) alert(log);
                }

            });

            function readURL(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        imgb64 = e.target.result;
                        $('#ImgUploadForm').attr('src', e.target.result);
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            $("#InputImgForm").change(function () {
                changed = true;
                readURL(this);
            });

            function readAudio(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        audiob64 = e.target.result;
                        $('#audioPlayer').attr('src', e.target.result);
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            $("#InputAudioForm").change(function () {
                changedAudio = true;
                readAudio(this);
            });
        });
    </script>

</body>

</html>