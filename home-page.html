
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script type="text/javascript" src="./js/jquery-3.5.1.min.js"></script>
    <script>
        $( "head" ).load( "./head-html.html" );

        $( "head" ).load( "./head-html.html", function( response, status, xhr ) {
            if ( status == "error" ) {
            var msg = "Desculpe, mas ocorreu um erro: " + xhr.status + " " + xhr.statusText;
            // $( "#error" ).html( msg + xhr.status + " " + xhr.statusText );
            alert (msg);
            }
        });
    </script>
</head>

<body>
    
    <div class="page-wrapper default-theme sidebar-bg bg1 toggled">
        <div id="sidebar-html"></div>
        <div id="preloader-html"></div>
        
        <script>
            $( "#sidebar-html" ).load( "sidebar-html.html" );
        </script>
        
        <script>
            $( "#preloader-html" ).load( "preloader-html.html" );
        </script>

        <!-- page-content  -->
        <main class="page-content pt-2">

            <div id="navbar-html"></div>
        
            <script>
                $( "#navbar-html" ).load( "navbar-html.html" );
            </script>

            <div id="overlay" class="overlay"></div>
    
            <div class="container-fluid p-5">
                <!-- COLOCAR CONTEUDO AQUI PARA BAIXO -->
                <!-- <h1>MUSICAS AQUIII</h1> -->

                <!-- Músicas filtradas por gênero e clima -->
                <div class="row">
                    <div class="col-md grid-filtrados pbshadow">
                        <h3 class="title-grid-filtrados">Todos os estilos</h3>
                        <span class="descricao_estilos"></span>
                        <div class="teste">
                            <!-- musicas -->
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <!-- Músicas favoritas -->
                    <div id="seus-favoritos" class="col-lg grid-favoritos pbshadow responsive">
                        <div class="table-responsive-xl">
                            <h3>Seus Favoritos</h3>
                            <span class="descricao_favoritos">10 músicas</span>
                            <div class="scroll">
                                <table id="table-favoritos" class="table table-borderless table-hover display">
                                    <thead>
                                        <tr>
                                            <th scope="col"></th> <!-- Botão de play -->
                                            <th scope="col">Título</th>
                                            <th scope="col">Artista</th>
                                            <th scope="col">Gênero, Clima</th><!-- Botão de favorito -->
                                            <th scope="col"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-musicas-favoritas">
                                       
                                        <!-- <tr>
                                            <td scope="row"></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr> -->
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Faixa atual -->
                    <div class="col-lg grid-player pbshadow responsive">
                        <h3 class="player">Escutando</h3>
                        
                        <div id="songs">
                            <li class="song">
                                <p class="song-title"></p>
                                <p class="song-artist"></p>
                                <p>
                                    <i id="favoritePlayer">
                                        <span id="favorite-star-fill">
                                            <img src="./assets/star-fill.svg">
                                        </span>
            
                                        <span id="favorite-star" style="display: none">
                                            <img src="./assets/star.svg">
                                        </span>
                                    </i>
                                </p>
                            </li>
                            
                        </div>

                        <div class="row" style="margin: 30px 0">
                            <div class="col-sm-12">
                                <div id="waveform" style="text-align: center;">
                                    <!-- Here be waveform -->
                                </div>
                            </div>
                        </div>

                        <div id="sub-controls">
                            <i id="skipBackward">
                                <span id="" style="display: none;">
                                    <img style="background-color: gray;" src="./assets/skip-back.svg">
                                </span>
                            </i>
                            <i id="rewind">
                                <span id="">
                                    <img src="./assets/rewind.svg">
                                </span>
                            </i>
                            <i id="playPause">
                                <span id="play">
                                    <img src="./assets/play-circle.svg">
                                </span>
    
                                <span id="pause" style="display: none">
                                    <img src="./assets/pause-circle.svg">
                                </span>
                            </i>
                            <i id="fast-forward">
                                <span id="">
                                    <img src="./assets/fast-forward.svg">
                                </span>
                            </i>
                            <i id="skip-forward" style="display: none;">
                                <span id="">
                                    <img style="background-color: gray;" src="./assets/skip-forward.svg">
                                </span>
                            </i>
                            <i id="toggleMute">
                                <span id="volume-on">
                                    <img src="./assets/volume-2.svg">
                                </span>
    
                                <span id="volume-x" style="display: none">
                                    <img src="./assets/volume-x.svg">
                                </span>
                            </i>
                            <i id="expandMinimize">
                                <span id="expand">
                                    <img src="./assets/external-link.svg">
                                </span>
    
                                <span id="minimize" style="display: none">
                                    <img src="./assets/minimize-2.svg">
                                </span>
                            </i>
                        </div>
                    </div>      
                </div>
            </div>

        </main>
        <!-- page-content" -->
        
    </div>
    <!-- page-wrapper -->

    <!-- using online scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous">
    </script>
    <script src="./js/jquery.mCustomScrollbar.concat.min.js"></script>

    <!-- <script src="https://code.jquery.com/jquery-3.5.1.js"></script> -->

    <script src="js/main.js"></script>
    <script src="./js/fakedb.js"></script>

    <script type="text/javascript" src="./js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="./js/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="./slick/slick.min.js"></script>

    <script src="https://unpkg.com/wavesurfer.js"></script>

    <script>
        var wavesurfer = WaveSurfer.create({
            container: document.querySelector('#waveform'),
            scrollParent: false,
            autoCenter: true,
            mediaControls: true,
            waveColor: '#fff',
            progressColor: '#0026ff',
            cursorColor: '#0026ff',
            barWidth: 2,
            barRadius: 3,
            cursorWidth: 1,
            height: 150,
            barGap: 2,
        });

        $(document).ready(function() {
            exibeMusicasFavoritas();
            exibeMusicas();

            $('.teste').slick({
                "infinite": true,
                "slidesToShow": 7, 
                "slidesToScroll": 7,
                "ots": true,
                "dots": true,
                responsive: [
                    {
                    breakpoint: 1024,
                        settings: {
                            slidesToShow: 6,
                            slidesToScroll: 6,
                            infinite: true,
                            dots: true
                        }
                    },
                    {
                    breakpoint: 900,
                        settings: {
                            slidesToShow: 5,
                            slidesToScroll: 5,
                            infinite: true,
                            dots: true
                        }
                    },
                    {
                    breakpoint: 800,
                        settings: {
                            slidesToShow: 4,
                            slidesToScroll: 4,
                            infinite: true,
                            dots: true
                        }
                    },
                    {
                    breakpoint: 700,
                        settings: {
                            slidesToShow: 3,
                            slidesToScroll: 3
                        }
                    },
                    {
                    breakpoint: 600,
                        settings: {
                            slidesToShow: 2,
                            slidesToScroll: 2
                        }
                    },
                    {
                    breakpoint: 480,
                        settings: {
                            slidesToShow: 1,
                            slidesToScroll: 1
                        }
                    }
                ]
            });

            var playPause = document.querySelector('#playPause');
            playPause.addEventListener('click', function() {
                wavesurfer.playPause();
            });

            var toggleMute = document.querySelector('#toggleMute');
            toggleMute.addEventListener('click', function() {
                wavesurfer.toggleMute();
                var stateMute = wavesurfer.getMute();
                if(stateMute) {
                    document.querySelector('#volume-on').style.display = 'none';
                    document.querySelector('#volume-x').style.display = '';
                } else {
                    document.querySelector('#volume-on').style.display = '';
                    document.querySelector('#volume-x').style.display = 'none';
                }
            });

            var stateMinimize = true;
            var expandMinimize = document.querySelector('#expandMinimize');
            expandMinimize.addEventListener('click', function() {
                if(stateMinimize) {
                    document.querySelector('#expand').style.display = 'none';
                    document.querySelector('#minimize').style.display = '';
                    stateMinimize = false;
                    ocultar();
                } else {
                    document.querySelector('#expand').style.display = '';
                    document.querySelector('#minimize').style.display = 'none';
                    stateMinimize = true;
                    exibir();
                }
            });
            
            function exibir() {
                document.getElementById("seus-favoritos").style.display = "block";
            }

            function ocultar() {
                document.getElementById("seus-favoritos").style.display = "none";
            }

            var rewind = document.querySelector('#rewind');
            rewind.addEventListener('click', function() {
                wavesurfer.skipBackward();
                wavesurfer.play();
            });

            var fastForward = document.querySelector('#fast-forward');
            fastForward.addEventListener('click', function() {
                wavesurfer.skipForward();
                wavesurfer.play();
            });

            // Toggle play/pause text
            wavesurfer.on('play', function() {
                document.querySelector('#play').style.display = 'none';
                document.querySelector('#pause').style.display = '';
            });
            wavesurfer.on('pause', function() {
                document.querySelector('#play').style.display = '';
                document.querySelector('#pause').style.display = 'none';
            });

            
            // The playlist links
            var links = document.querySelectorAll('#table-musicas-favoritas a#btnPlay');
            var currentTrack = 0;
            // console.log(links)

            // Load a track by index and highlight the corresponding link
            var setCurrentSong = function(index) {
                document.getElementById('table-musicas-favoritas').getElementsByTagName('tr')[currentTrack].classList.remove("active");
                // links[currentTrack].classList.remove('active');
                currentTrack = index;
                // links[currentTrack].classList.add('active');
                document.getElementById('table-musicas-favoritas').getElementsByTagName('tr')[currentTrack].classList.add("active");
        
                //title
                var title = document.querySelectorAll('#table-musicas-favoritas tr td')[(currentTrack)*5+1];
                $(".song-title").text(title.textContent);

                //artist
                var artist = document.querySelectorAll('#table-musicas-favoritas tr td')[(currentTrack)*5+2];
                $(".song-artist").text(artist.textContent);
                
                var id = document.querySelectorAll('#table-musicas-favoritas tr td')[(currentTrack)*5+0].querySelectorAll('#btnFavoritar')[0].getAttributeNode('value').value;
                
                var musica = buscarMusicaPorId(parseInt(id));
                var url = `url("${musica.imagem}")`;
                $('.grid-player').css('background-image', url);

                // var musica = document.getElementById('table-musicas-favoritas').getElementsByTagName('tr')[currentTrack].getElementsByTagName('td')[0];
                // console.log(musica.getElementsByTagName('a'));
                
                // $("#table-musicas-favoritas a").addClass("active");
                wavesurfer.load(links[currentTrack].href);
                
            };

            // Load the track on click
            Array.prototype.forEach.call(links, function(link, index) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if(wavesurfer.isPlaying()){
                        wavesurfer.pause();
                    }
                    wavesurfer.empty();
                    wavesurfer.cancelAjax();
                    setCurrentSong(index);
                });
            });

            // Play on audio load
            wavesurfer.on('ready', function() {
                wavesurfer.pause();
            });

            wavesurfer.on('error', function(e) {
                console.warn(e);
            });

            // Go to the next track on finish
            wavesurfer.on('finish', function() {
                setCurrentSong((currentTrack + 1) % links.length);
            });

            // Load the first track
            setCurrentSong(currentTrack);
        });

        var dbtable = {
            "data": []
        }

        function favoritar(id) {
            var url_image = $("#favorite"+id).attr('src');
            // alert(url_image);
            switch (url_image) {
                case "../assets/star-fill.svg"://estado atual: favorito
                    if(removerFatoritoPorUsuario(id)){
                        document.getElementById("favorite"+id).src ="../assets/star.svg";
                        exibeMusicasFavoritas();
                    }
                    break;
                case "../assets/star.svg"://estado atual: não favorito
                    if(adicionarFatoritoPorUsuario(id)){
                        document.getElementById("favorite"+id).src ="../assets/star-fill.svg";
                        exibeMusicasFavoritas();
                    }
                    break;
                default:
                    alert("failed")
                    break;
            }
        }
        
        function exibeMusicasFavoritas() {
            // Remove todas as linhas do corpo da tabela
            $("#table-musicas-favoritas").html("");
            // Popula a tabela com os registros do banco de dados
            db_favoritos_doUsuario = buscarFavoritosPeloUsuario();
            if(db_favoritos_doUsuario != null ){
                $(".descricao_favoritos").text(db_favoritos_doUsuario.data.length + " músicas");
                for (i = 0; i < db_favoritos_doUsuario.data.length; i++) {
                    let musica = db_favoritos_doUsuario.data[i];

                    let buttonFavoritar = '<a id="btnFavoritar" onclick="favoritar(' + musica.id + ')" value="' + musica.id + '" type="button" class="mr-1 rounded-lg"><img id="favorite' + musica.id + '" src="../assets/star-fill.svg"></a>';
                    let buttonPlay = '<a id="btnPlay" href="' + musica.audio + '" onclick="play(' + musica.id + ')" value="' + musica.id + '" type="button" class="mr-1 rounded-lg"><img src="./assets/play.svg"></a>';

                    $("#table-musicas-favoritas").append(
                        `<tr>
                        <a href="${musica.audio}">
                            <td>${buttonFavoritar}</td>
                            <td>${musica.nome}</td>
                            <td>${musica.artista}</td>
                            <td>${musica.genero}, ${musica.clima}</td>
                            <td>${buttonPlay}</td>
                        </a></tr>`
                    );
                
                }
            }
        }

        function exibeMusicas(){
            $(".teste").html("");
            // $('.teste').slick('slickAdd','<div><h3>' + slideIndex + '</h3></div>');
            aux = false;
            musicas_filtro_genero = JSON.parse(localStorage.getItem('musicas_filtro_genero'));
            var genero_filtro = buscarGeneroPorId(musicas_filtro_genero);
            musicas_cadastradas = JSON.parse(localStorage.getItem('musicas_cadastradas'));
            if(musicas_cadastradas != null ){
                $(".descricao_estilos").text(genero_filtro.qtde + " músicas");
                $(".title-grid-filtrados").text(genero_filtro.nome);
                for (i = 0; i < musicas_cadastradas.data.length; i++) {
                    if(genero_filtro.id == 0){
                        aux = true;
                    }else{
                        aux = false;
                        if(musicas_cadastradas.data[i].genero == genero_filtro.nome && genero_filtro.id > 0){
                            aux = true;
                        }
                    }
                    
                    if(aux){
                        let musica = musicas_cadastradas.data[i];
                        let buttonFavoritar;
                        if(verificarFavoritoUsuario(musica.id)){
                            buttonFavoritar = '<a id="btnFavoritar" onclick="favoritar(' + musica.id + ')" value="' + musica.id + '" type="button" class="mr-1 rounded-lg"><img id="favorite' + musica.id + '" src="../assets/star-fill.svg"></a>';                    
                        }else{
                            buttonFavoritar = '<a id="btnFavoritar" onclick="favoritar(' + musica.id + ')" value="' + musica.id + '" type="button" class="mr-1 rounded-lg"><img id="favorite' + musica.id + '" src="../assets/star.svg"></a>';                    
                        }
                        $(".teste").append(
                            `<div class="track">
                                
                                <img style="border-radius: 1em; margin-bottom: 1em" src="${musica.imagem}" width=auto height=150 class="card-img-top arredondar" alt="...">
                                ${buttonFavoritar}</img>
                                <p><strong>${musica.nome}</strong> • ${musica.artista}</p>
                            </div>`
                        );
                    }
                }
            }
        }

        

    </script> 
</body>

</html>